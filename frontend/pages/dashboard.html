<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHAMA SOS - Dashboard</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#B71C1C">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body class="dashboard-page">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <!-- Logo e Menu Toggle -->
            <a class="navbar-brand d-flex align-items-center" href="#">
                <div class="navbar-logo">
                    <i class="bi bi-fire"></i>
                </div>
                <span class="ms-2">CHAMA SOS</span>
            </a>
            
            <!-- User Menu (Desktop) -->
            <div class="d-none d-lg-flex align-items-center ms-auto">
                <div class="user-info me-3">
                    <div class="user-name" id="userName">Carregando...</div>
                    <div class="user-role" id="userRole">Bombeiro</div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" id="btnProfile">
                            <i class="bi bi-person me-2"></i>Meu Perfil
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" id="btnLogout">
                            <i class="bi bi-box-arrow-right me-2"></i>Sair
                        </a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Mobile Menu Toggle -->
            <button class="navbar-toggler d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#mobileMenu">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>
    
    <!-- Mobile Menu -->
    <div class="collapse d-lg-none" id="mobileMenu">
        <div class="mobile-menu bg-dark p-3">
            <div class="user-info-mobile text-center mb-4">
                <div class="user-avatar-mobile mb-2">
                    <i class="bi bi-person-circle"></i>
                </div>
                <div class="user-name" id="userNameMobile"></div>
                <div class="user-role" id="userRoleMobile"></div>
            </div>
            
            <div class="nav flex-column">
                <a class="nav-link active" href="#" data-page="dashboard">
                    <i class="bi bi-speedometer2 me-2"></i>Dashboard
                </a>
                <a class="nav-link" href="#" data-page="ocorrencias">
                    <i class="bi bi-list-task me-2"></i>Ocorrências
                </a>
                <a class="nav-link" href="#" data-page="nova-ocorrencia">
                    <i class="bi bi-plus-circle me-2"></i>Nova Ocorrência
                </a>
                <a class="nav-link" href="#" data-page="relatorios">
                    <i class="bi bi-file-earmark-text me-2"></i>Relatórios
                </a>
                <hr class="text-light">
                <a class="nav-link" href="#" id="btnProfileMobile">
                    <i class="bi bi-person me-2"></i>Meu Perfil
                </a>
                <a class="nav-link text-danger" href="#" id="btnLogoutMobile">
                    <i class="bi bi-box-arrow-right me-2"></i>Sair
                </a>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="container-fluid main-container">
        <div class="row">
            <!-- Sidebar (Desktop) -->
            <nav class="col-lg-2 d-none d-lg-block sidebar bg-white shadow">
                <div class="sidebar-sticky pt-4">
                    <!-- User Info Sidebar -->
                    <div class="user-info-sidebar text-center mb-4">
                        <div class="user-avatar mb-3">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <h6 class="user-name" id="userNameSidebar"></h6>
                        <small class="user-role text-muted" id="userRoleSidebar"></small>
                    </div>
                    
                    <!-- Navigation -->
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-page="dashboard">
                                <i class="bi bi-speedometer2 me-2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="ocorrencias">
                                <i class="bi bi-list-task me-2"></i>
                                Ocorrências
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="nova-ocorrencia">
                                <i class="bi bi-plus-circle me-2"></i>
                                Nova Ocorrência
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="relatorios">
                                <i class="bi bi-file-earmark-text me-2"></i>
                                Relatórios
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="recursos">
                                <i class="bi bi-truck me-2"></i>
                                Recursos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="mapa">
                                <i class="bi bi-map me-2"></i>
                                Mapa
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Status -->
                    <div class="sidebar-status mt-5">
                        <div class="status-item d-flex justify-content-between mb-2">
                            <span class="text-muted">Turno:</span>
                            <span class="fw-bold" id="userShift">07:00-19:00</span>
                        </div>
                        <div class="status-item d-flex justify-content-between mb-2">
                            <span class="text-muted">Região:</span>
                            <span class="fw-bold" id="userRegion">RMR</span>
                        </div>
                        <div class="status-item d-flex justify-content-between">
                            <span class="text-muted">Online:</span>
                            <span class="badge bg-success" id="statusOnline">
                                <i class="bi bi-wifi"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </nav>
            
            <!-- Main Content Area -->
            <main class="col-lg-10 ms-sm-auto px-md-4 main-content">
                <!-- Page Header -->
                <div class="page-header d-flex justify-content-between align-items-center py-3 mb-4 border-bottom">
                    <div>
                        <h2 class="page-title" id="pageTitle">Dashboard</h2>
                        <p class="page-subtitle text-muted" id="pageSubtitle">
                            <span id="currentDate"></span> • 
                            <span id="currentTime"></span>
                        </p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-danger" id="btnRefresh">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button class="btn btn-danger" id="btnEmergency">
                            <i class="bi bi-exclamation-triangle me-2"></i>Emergência
                        </button>
                    </div>
                </div>
                
                <!-- Content -->
                <div id="content" class="fade-in">
                    <!-- Dashboard content will be loaded here -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-3">Carregando dashboard...</p>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Floating Action Button (Mobile) -->
    <button class="btn btn-danger btn-floating d-lg-none" id="fabEmergency">
        <i class="bi bi-exclamation-triangle"></i>
    </button>
    
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <i class="bi bi-wifi-off me-2"></i>
        Você está offline. Algumas funcionalidades podem estar limitadas.
    </div>
    
    <!-- Loading Overlay -->
    <div class="spinner-overlay d-none" id="globalLoading">
        <div class="spinner"></div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Dashboard JS -->
    <script type="module">
        import { loadDashboard, initNavigation, loadUserInfo } from './js/dashboard.js';
        import { logout } from './js/auth.js';
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', async () => {
            // Mostrar loading
            document.getElementById('globalLoading').classList.remove('d-none');
            
            try {
                // Carregar informações do usuário
                await loadUserInfo();
                
                // Inicializar navegação
                initNavigation();
                
                // Carregar dashboard inicial
                await loadDashboard();
                
                // Atualizar data e hora
                updateDateTime();
                setInterval(updateDateTime, 60000);
                
                // Monitorar conexão
                monitorConnection();
                
            } catch (error) {
                console.error('Erro ao inicializar:', error);
                showError('Erro ao carregar dashboard');
            } finally {
                document.getElementById('globalLoading').classList.add('d-none');
            }
            
            // Configurar botões de logout
            ['btnLogout', 'btnLogoutMobile'].forEach(id => {
                document.getElementById(id)?.addEventListener('click', async (e) => {
                    e.preventDefault();
                    if (confirm('Deseja realmente sair?')) {
                        await logout();
                        window.location.href = 'login.html';
                    }
                });
            });
            
            // Botão de emergência
            document.getElementById('btnEmergency')?.addEventListener('click', () => {
                window.location.href = 'nova-ocorrencia.html?emergency=true';
            });
            
            document.getElementById('fabEmergency')?.addEventListener('click', () => {
                window.location.href = 'nova-ocorrencia.html?emergency=true';
            });
            
            // Botão de refresh
            document.getElementById('btnRefresh')?.addEventListener('click', () => {
                location.reload();
            });
        });
        
        // Funções auxiliares
        function updateDateTime() {
            const now = new Date();
            
            // Formatar data
            const dateOptions = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('currentDate').textContent = 
                now.toLocaleDateString('pt-BR', dateOptions);
            
            // Formatar hora
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit' 
            };
            document.getElementById('currentTime').textContent = 
                now.toLocaleTimeString('pt-BR', timeOptions);
        }
        
        function monitorConnection() {
            const indicator = document.getElementById('offlineIndicator');
            
            function updateStatus() {
                if (navigator.onLine) {
                    indicator.classList.remove('show');
                    document.getElementById('statusOnline').className = 'badge bg-success';
                    document.getElementById('statusOnline').innerHTML = '<i class="bi bi-wifi"></i>';
                } else {
                    indicator.classList.add('show');
                    document.getElementById('statusOnline').className = 'badge bg-danger';
                    document.getElementById('statusOnline').innerHTML = '<i class="bi bi-wifi-off"></i>';
                }
            }
            
            window.addEventListener('online', updateStatus);
            window.addEventListener('offline', updateStatus);
            updateStatus();
        }
        
        function showError(message) {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle me-2"></i>Erro</h5>
                    <p>${message}</p>
                    <button class="btn btn-danger mt-2" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Tentar novamente
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>